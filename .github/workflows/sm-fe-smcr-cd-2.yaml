name: CD - SM-FE-SMCR 2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment where the artifact will be deployed.
        type: string
        required: true
        default: "app-prod"
      resource_group_name:
        description: "Web App resource group name"
        type: string
        required: true
        default: "plsm-p-itn-apps-rg-01"
      web_app_name:
        description: "Web App name"
        type: string
        required: true
        default: "plsm-p-itn-fsmcr-app-01"
      use_private_agent:
        description: Use a private agent
        type: boolean
        default: true
      use_labels:
        description: Use labels for self-hosted runner
        type: boolean
        default: false
      override_labels:
        type: string
        default: ""

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: "22"
  NEXT_APP_PATH: "./apps/sm-fe-smcr"
  ARTIFACT_NAME: "bundle"
  RESOURCE_GROUP_NAME: ${{ inputs.resource_group_name }}
  WEB_APP_NAME: ${{ inputs.web_app_name }}

jobs:

  # ============================================
  # BUILD JOB
  # ============================================
  build:
    name: ðŸ— Build & Package Artifact
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}

    env:
      NEXT_PUBLIC_MSAL_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_MSAL_CLIENT_ID }}
      NEXT_PUBLIC_MSAL_TENANT_ID: ${{ secrets.NEXT_PUBLIC_MSAL_TENANT_ID }}
      NEXT_PUBLIC_MSAL_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_MSAL_REDIRECT_URI }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build with Turbo
        run: yarn turbo build --filter=sm-fe-smcr

      - name: Create Standalone Bundle
        id: package-artifact
        working-directory: ${{ env.NEXT_APP_PATH }}
        run: |
          zip -r ${{ env.ARTIFACT_NAME }}.zip .next/standalone/
          echo "artifact-path=$(realpath ${{ env.ARTIFACT_NAME }}.zip)" >> "$GITHUB_OUTPUT"

      - name: Upload Artifact
        uses: actions/upload-artifact@v5.0.0
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ steps.package-artifact.outputs.artifact-path }}
          retention-days: 7


  # ============================================
  # DEPLOY (STAGING)
  # ============================================
  deploy_to_staging:
    name: ðŸš€ Deploy to Staging
    needs: build
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}-cd

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: .

      - name: Login to Azure via OIDC (App Registration ONLY)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}
          allow-no-subscriptions: false
          enable-AzPSSession: false

      - name: Deploy to Azure WebApp (Staging)
        uses: azure/webapps-deploy@122b7ec46017e53a3f71e3a027d67550a1641f5e
        with:
          resource-group-name: ${{ env.RESOURCE_GROUP_NAME }}
          app-name: ${{ env.WEB_APP_NAME }}
          slot-name: staging
          package: ${{ env.ARTIFACT_NAME }}.zip
          app-insights: false


  # ============================================
  # SWAP TO PRODUCTION
  # ============================================
  swap_to_production:
    name: âœ¨ Swap Staging â†’ Production
    needs: deploy_to_staging
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}-cd

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Login to Azure via OIDC (App Registration ONLY)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}
          allow-no-subscriptions: false
          enable-AzPSSession: false

      - name: Swap Staging to Production
        run: |
          az webapp deployment slot swap \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --name "${{ env.WEB_APP_NAME }}" \
            --slot staging \
            --target-slot production \
            --output none

