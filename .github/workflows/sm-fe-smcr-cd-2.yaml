name: Deploy - SM-FE-SMCR (MODE A - Safe Deploy)

on:
  workflow_dispatch:
    inputs:
      workspace_name:
        description: "Workspace name"
        type: string
        required: true
        default: "sm-fe-smcr"
      
      next_app_path:
        description: "NextJS App Path"
        type: string
        required: true
        default: "./apps/sm-fe-smcr"

      environment:
        description: Environment where the artifact will be deployed
        type: string
        required: true
        default: "app-prod"

      resource_group_name:
        type: string
        required: true
        default: "plsm-p-itn-apps-rg-01"

      web_app_name:
        type: string
        required: true
        default: "plsm-p-itn-fsmcr-app-01"

      use_private_agent:
        description: Use a private agent to deploy the built artifact.
        type: boolean
        required: false
        default: true

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: "22"
  WORKSPACE_NAME: ${{ inputs.workspace_name }}
  NEXT_APP_PATH: ${{ inputs.next_app_path }}
  BUNDLE_NAME: "bundle"
  RESOURCE_GROUP_NAME: ${{ inputs.resource_group_name }}
  WEB_APP_NAME: ${{ inputs.web_app_name }}

jobs:
  # --------------------------------------------------------------------
  # BUILD
  # --------------------------------------------------------------------
  build:
    name: ðŸ— Build & Package Artifact
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}

    env:
      MSAL_CLIENT_ID: ${{ secrets.MSAL_CLIENT_ID }}
      MSAL_TENANT_ID: ${{ secrets.MSAL_TENANT_ID }}
      MSAL_REDIRECT_URI: ${{ secrets.MSAL_REDIRECT_URI }}
      NEXT_PUBLIC_MSAL_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_MSAL_CLIENT_ID }}
      NEXT_PUBLIC_MSAL_TENANT_ID: ${{ secrets.NEXT_PUBLIC_MSAL_TENANT_ID }}
      NEXT_PUBLIC_MSAL_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_MSAL_REDIRECT_URI }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build (Turbo - monorepo)
        run: yarn turbo build --filter=${{ env.WORKSPACE_NAME }}

      # --- IMPORTANTISSIMO ---
      # Next.js Standalone bundle COMPLETO (static + public)
      - name: Prepare Next.js Standalone Bundle
        working-directory: ${{ env.NEXT_APP_PATH }}
        run: |
          mkdir bundle
          cp -R .next/standalone/* bundle/
          cp -R public bundle/ || true
          cp -R .next/static bundle/.next/static || true

      - name: Create ZIP Artifact
        run: |
          cd ${{ env.NEXT_APP_PATH }}/bundle
          zip -r ../../${{ env.BUNDLE_NAME }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.BUNDLE_NAME }}
          path: ${{ env.NEXT_APP_PATH }}/${{ env.BUNDLE_NAME }}.zip

  # --------------------------------------------------------------------
  # DEPLOY TO STAGING SLOT
  # --------------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy a Staging
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    needs: build
    environment: ${{ inputs.environment }}-cd

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v5
        with:
          name: bundle
          path: .

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Deploy ZIP with CLI
        run: |
          az webapp deploy \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --name "${{ env.WEB_APP_NAME }}" \
            --slot staging \
            --src-path bundle.zip \
            --type zip \
            --async false

  # --------------------------------------------------------------------
  # SWAP STAGING â†’ PRODUCTION
  # --------------------------------------------------------------------
  swap:
    name: âœ¨ Swap Staging -> Production
    needs: deploy
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}-cd 

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Swap staging â†’ production
        run: |
          az webapp deployment slot swap \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --name "${{ env.WEB_APP_NAME }}" \
            --slot staging \
            --target-slot production


