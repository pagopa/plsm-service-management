name: Deploy - SM-FE-SMCR

on:
  workflow_dispatch:
    inputs:
      workspace_name:
        description: "Workspace name"
        type: string
        required: true
        default: "sm-fe-smcr"
      
      next_app_path:
        description: "NextJS App Path"
        type: string
        required: true
        default: "./apps/sm-fe-smcr"

      environment:
        description: Environment where the artifact will be deployed
        type: string
        required: true
        default: "app-prod"

      resource_group_name:
        description: "Web App Resource Group"
        type: string
        required: true
        default: "plsm-p-itn-apps-rg-01"

      web_app_name:
        description: "Web App Name"
        type: string
        required: true
        default: "plsm-p-itn-fsmcr-app-01"

      use_private_agent:
        description: Use a private agent to deploy the built artifact.
        type: boolean
        required: false
        default: true

      use_labels:
        description: Use labels to start the right environment's GitHub runner.
        type: boolean
        required: false
        default: false

      override_labels:
        description: Custom runner label override
        type: string
        required: false
        default: ""

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: "22"
  WORKSPACE_NAME: ${{ inputs.workspace_name }}
  NEXT_APP_PATH: ${{ inputs.next_app_path }}
  BUNDLE_NAME: "bundle"
  RESOURCE_GROUP_NAME: ${{ inputs.resource_group_name }}
  WEB_APP_NAME: ${{ inputs.web_app_name }}

jobs:

  # --------------------------------------------------------------------
  # üèó BUILD & PACKAGE
  # --------------------------------------------------------------------
  build:
    name: üèó Build & Package Artifact
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}

    env:
      # NEXT PUBLIC ENV
      NEXT_PUBLIC_MSAL_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_MSAL_CLIENT_ID }}
      NEXT_PUBLIC_MSAL_TENANT_ID: ${{ secrets.NEXT_PUBLIC_MSAL_TENANT_ID }}
      NEXT_PUBLIC_MSAL_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_MSAL_REDIRECT_URI }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}

      # SERVER ENV
      MSAL_CLIENT_ID: ${{ secrets.MSAL_CLIENT_ID }}
      MSAL_TENANT_ID: ${{ secrets.MSAL_TENANT_ID }}
      MSAL_REDIRECT_URI: ${{ secrets.MSAL_REDIRECT_URI }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build (Turbo - monorepo)
        run: yarn turbo build --filter=${{ env.WORKSPACE_NAME }}

      # ------------------------
      # üåê PACKAGE NEXT STEPS
      # ------------------------
      - name: Prepare Next.js Standalone Bundle
        working-directory: ${{ env.NEXT_APP_PATH }}
        run: |
          rm -rf build
          mkdir -p build

          # Standalone server (server.js, chunks, node_modules trimmed)
          cp -R .next/standalone/* build/

          # Static assets
          mkdir -p build/.next/static
          if [ -d ".next/static" ]; then
            cp -R .next/static/* build/.next/static/
          fi

          # Public folder
          if [ -d "public" ]; then
            cp -R public build/
          fi

      - name: Create ZIP Artifact
        working-directory: ${{ env.NEXT_APP_PATH }}/build
        run: |
          zip -r ../${{ env.BUNDLE_NAME }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.BUNDLE_NAME }}
          path: ${{ env.NEXT_APP_PATH }}/${{ env.BUNDLE_NAME }}.zip

  # --------------------------------------------------------------------
  # üöÄ DEPLOY TO STAGING SLOT
  # --------------------------------------------------------------------
  deploy:
    name: üöÄ Deploy to Staging
    needs: build
    environment: ${{ inputs.environment }}-cd
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v5
        with:
          name: bundle
          path: .

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Deploy ZIP with CLI
        run: |
          az webapp deploy \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --name "${{ env.WEB_APP_NAME }}" \
            --slot staging \
            --src-path bundle.zip \
            --type zip \
            --async false

  # --------------------------------------------------------------------
  # ‚ú® SWAP ‚Üí PRODUCTION
  # --------------------------------------------------------------------
  swap:
    name: ‚ú® Swap Staging ‚Üí Production
    needs: deploy
    environment: ${{ inputs.environment }}-cd
    runs-on: ${{ inputs.use_labels && inputs.use_private_agent && (inputs.override_labels != '' && inputs.override_labels || inputs.environment) || inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Swap staging ‚Üí production
        run: |
          az webapp deployment slot swap \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --name "${{ env.WEB_APP_NAME }}" \
            --slot staging \
            --target-slot production
